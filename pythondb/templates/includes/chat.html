<div class="chat-container">
    <h1>Chat with GPT</h1>
    <div class="messages">
        {% for dialogue in dialogues %}
            <div class="message user-message">
                {{ dialogue.user_message }}
            </div>
            <div class="message bot-message">
                <div class="bot-content">{{ dialogue.bot_message|safe }}</div>
            </div>
        {% endfor %}

        {% if reply %}
            <div class="message user-message">
                {{ form.message.value }}
            </div>
            <div class="message bot-message">
                <div class="bot-content">{{ reply|safe }}</div>
            </div>
        {% endif %}
    </div>
    <form method="post" id="chat-form" action="{% url 'gpt:chat' %}">
        {% csrf_token %}
        <textarea name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button type="submit">üåê</button>
    </form>
    <form method="post" action="{% url 'gpt:clean_chat' %}">
        {% csrf_token %}
        <button type="submit" class="clean-button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </form>
</div>
<button id="toggle-chat" class="toggle-button">‚ñº</button>
<!-- –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->



<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messagesDiv = document.querySelector('.messages');

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    if (chatForm) {
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            sendMessage();
        });

        const textarea = chatForm.querySelector('textarea');
        if (textarea) {
            textarea.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }
    }

    function sendMessage() {
        const form = document.getElementById('chat-form');
        const formData = new FormData(form);
        const messagesDiv = document.querySelector('.messages');

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.textContent = formData.get('message');
        messagesDiv.appendChild(userMessage);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
        const statusMessage = document.createElement('div');
        statusMessage.className = 'message status-message';
        statusMessage.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞...';
        messagesDiv.appendChild(statusMessage);

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),  // –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω
            },
        })
        .then(response => response.json())
        .then(data => {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
            messagesDiv.removeChild(statusMessage);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            botMessage.innerHTML = `<div class="bot-content">${data.reply}</div>`;
            messagesDiv.appendChild(botMessage);

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            form.reset();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            messagesDiv.removeChild(statusMessage);
        });
    }
});
document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('toggle-chat');
    const chatContainer = document.querySelector('.chat-container');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const isCollapsed = localStorage.getItem('chatCollapsed') === 'true';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (isCollapsed) {
        chatContainer.classList.add('collapsed');
        toggleButton.textContent = '‚ñ≤'; // –ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    } else {
        toggleButton.textContent = '‚ñº'; // –ò–∫–æ–Ω–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    }

    // –î–µ–ª–∞–µ–º —á–∞—Ç –≤–∏–¥–∏–º—ã–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    chatContainer.classList.add('visible');

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    toggleButton.addEventListener('click', function () {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        chatContainer.classList.toggle('collapsed');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
        const isNowCollapsed = chatContainer.classList.contains('collapsed');
        localStorage.setItem('chatCollapsed', isNowCollapsed);

        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        if (isNowCollapsed) {
            toggleButton.textContent = '‚ñ≤'; // –ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        } else {
            toggleButton.textContent = '‚ñº'; // –ò–∫–æ–Ω–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        }
    });
});
</script>
