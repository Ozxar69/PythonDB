{% extends 'base.html' %}
{% load static %}
{% block title %}
GPT - 4o -
{% endblock %}
{% block content %}

<div class="chat-container-full">

    <h1>Chat with GPT</h1>
    <div class="messages-full">
        {% for dialogue in dialogues %}
            <div class="message user-message">
                {{ dialogue.user_message|safe }}
            </div>
            <div class="message bot-message">
                <div class="bot-content">{{ dialogue.bot_message|safe }}</div>
            </div>
        {% endfor %}

        {% if reply %}
            <div class="message user-message">
                {{ form.message.value }}
            </div>
            <div class="message bot-message">
                <div class="bot-content">{{ reply|safe }}</div>
            </div>
        {% endif %}
    </div>
    <form method="post" id="chat-form" action="{% url 'gpt:chat' %}">
        {% csrf_token %}
        <textarea id="message-input" name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button type="submit">üåê</button>
    </form>
    <form method="post" action="{% url 'gpt:clean_chat' %}">
        {% csrf_token %}
        <button type="submit" class="clean-button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const messagesDiv = document.querySelector('.messages-full');

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
    if (textarea) {
        textarea.addEventListener('input', function () {
            this.style.height = 'auto'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
            this.style.height = Math.min(this.scrollHeight, 200) + 'px'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤—ã—Å–æ—Ç—É (–º–∞–∫—Å. 200px)
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    if (chatForm) {
        chatForm.addEventListener('submit', function (event) {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            sendMessage();
        });

        if (textarea) {
            textarea.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                    sendMessage();
                }
            });
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendMessage() {
    const form = document.getElementById('chat-form');
    const formData = new FormData(form);
    const messagesDiv = document.querySelector('.messages-full');

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
    const userMessage = document.createElement('div');
    userMessage.className = 'message user-message';
    userMessage.innerHTML = formData.get('message'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML
    messagesDiv.appendChild(userMessage);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
    const statusMessage = document.createElement('div');
    statusMessage.className = 'message status-message';
    statusMessage.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞...';
    messagesDiv.appendChild(statusMessage);

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
    },
})
.then(response => response.json())
.then(data => {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
    messagesDiv.removeChild(statusMessage);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
    const botMessage = document.createElement('div');
    botMessage.className = 'message bot-message';
    botMessage.innerHTML = `<div class="bot-content">${data.reply}</div>`;
    messagesDiv.appendChild(botMessage);

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
    Prism.highlightAllUnder(botMessage);

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    form.reset();
})
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        messagesDiv.removeChild(statusMessage);
    });
}
</script>

{% endblock %}
